<?xml version="1.0"?>
<!-- Copyright (c) 2017 Haggai Nuchi
Available for use under the MIT License:
https://opensource.org/licenses/MIT
 -->

<bindings id="generalBindings"
   xmlns="http://www.mozilla.org/xbl"
   xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
   xmlns:xbl="http://www.mozilla.org/xbl">

  <binding id="js" extends="chrome://global/content/bindings/toolbarbutton.xml#menu">
    <implementation>
        <constructor><![CDATA[
            var getURLSpecFromFile = Components.classes["@mozilla.org/network/io-service;1"].getService(Components.interfaces.nsIIOService).getProtocolHandler("file").QueryInterface(Components.interfaces.nsIFileProtocolHandler).getURLSpecFromFile;
			var chromeDir = Components.classes["@mozilla.org/file/directory_service;1"].getService(Components.interfaces.nsIProperties).get("UChrm", Components.interfaces.nsIFile);
			var files = chromeDir.directoryEntries.QueryInterface(Components.interfaces.nsISimpleEnumerator);
			var xul_files = [];
			
			while(files.hasMoreElements()) {
				var file = files.getNext().QueryInterface(Components.interfaces.nsIFile);
				
				if(/(^userChrome|\.uc)\.js$/i.test(file.leafName)) {
					setTimeout(function(aFile) {
						Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader).loadSubScript(getURLSpecFromFile(aFile));
					}, 0, file);
				}
				else if(/(^userChrome|\.uc)\.xul$/i.test(file.leafName)) {
					xul_files.push(file);
				}
			}
			
			setTimeout(function() {
				if(xul_files.length > 0) {
					document.loadOverlay(getURLSpecFromFile(xul_files.shift()), null);
					setTimeout(arguments.callee, 0);
				}
			}, 0);
        ]]></constructor>
    </implementation>
  </binding>
</bindings>
